<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Download File Example</title>
  <style>
    #downloadBtn {
      background: none;
      border: none;
      padding: 0;
      font: inherit;
      color: #0b5ed7;
      text-decoration: underline;
      cursor: pointer;
    }
    #downloadBtn:disabled {
      color: #999;
      text-decoration: none;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Download My File</h1>
  <p>Click below to download the file directly from Google Drive:</p>

  <!-- Button -->
  <button id="downloadBtn" disabled>ðŸ“¥ Preparing downloadâ€¦</button>

  <!-- Android-only + original open-in-new-tab download -->
  <script>
    const isAndroid = /Android/i.test(navigator.userAgent);
    const btn = document.getElementById("downloadBtn");

    if (!isAndroid) {
      // Non-Android devices: just show "Not available"
      btn.textContent = "Not available";
      btn.disabled = true;
    } else {
      let driveURL = null;

      fetch("filelink.json", { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error("filelink.json not found");
          return res.json();
        })
        .then(data => {
          driveURL = data.url;
          btn.textContent = "ðŸ“¥ Download APK";
          btn.disabled = false;

          btn.addEventListener("click", () => {
            if (!driveURL) {
              alert("Download link not ready yet. Please try again.");
              return;
            }
            // Original behavior (opens new tab)
            const a = document.createElement("a");
            a.href = driveURL;
            a.target = "_blank";
            a.rel = "noopener";
            a.download = "";
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          });
        })
        .catch(err => {
          console.error("Error loading filelink.json:", err);
          btn.textContent = "Error loading download link.";
          btn.disabled = true;
        });
    }
  </script>

  <!-- 1-hour redirect security -->
  <script>
    (function () {
      const startKey = "pageStartTime";
      const guardPage = "index.html";
      const ONE_HOUR = 5 * 60 * 1000;
      const CHECK_EVERY = 2 * 60 * 1000;

      let startTime = parseInt(localStorage.getItem(startKey), 10);
      if (Number.isNaN(startTime)) {
        startTime = Date.now();
        localStorage.setItem(startKey, String(startTime));
      }

      function msRemaining() {
        const elapsed = Date.now() - startTime;
        return Math.max(0, ONE_HOUR - elapsed);
      }

      function redirectToGuard() {
        try { localStorage.removeItem(startKey); } catch (e) {}
        window.location.replace(guardPage);
      }

      function checkAndRedirect() {
        if (msRemaining() <= 0) redirectToGuard();
      }

      const exactTimeout = setTimeout(checkAndRedirect, msRemaining());
      const interval = setInterval(checkAndRedirect, CHECK_EVERY);
      ["visibilitychange", "focus"].forEach(evt =>
        window.addEventListener(evt, checkAndRedirect)
      );
      window.addEventListener("beforeunload", () => {
        clearTimeout(exactTimeout);
        clearInterval(interval);
      });
    })();
  </script>

  <!-- Deterrents -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", e => {
      if (e.key === "F12") e.preventDefault();
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && (k === "u" || k === "s" || k === "i" || k === "j" || k === "c")) e.preventDefault();
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && (k === "i" || k === "j" || k === "c")) e.preventDefault();
    });
  </script>
</body>
</html>
