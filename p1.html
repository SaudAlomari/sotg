<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Download File Example</title>
  <style>
    /* Optional: make the button look like your previous link */
    #downloadBtn {
      background: none;
      border: none;
      padding: 0;
      font: inherit;
      color: #0b5ed7;
      text-decoration: underline;
      cursor: pointer;
    }
    #downloadBtn:disabled {
      color: #999;
      text-decoration: none;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Download My File</h1>
  <p>Click below to download the file directly from Google Drive:</p>

  <!-- Button (no visible href to copy) -->
  <button id="downloadBtn" disabled>ðŸ“¥ Preparing downloadâ€¦</button>

  <!-- Load link from JSON + trigger download via hidden iframe (no new tab) -->
  <script>
    let driveURL = null;

    // Fetch the link at runtime (not in the DOM)
    fetch("filelink.json", { cache: "no-store" })
      .then(res => {
        if (!res.ok) throw new Error("filelink.json not found");
        return res.json();
      })
      .then(data => {
        driveURL = data.url;
        const btn = document.getElementById("downloadBtn");
        btn.textContent = "ðŸ“¥ Download APK";
        btn.disabled = false;

        btn.addEventListener("click", () => {
          if (!driveURL) {
            alert("Download link not ready yet. Please try again.");
            return;
          }

          // Create (or reuse) a hidden iframe so the current tab doesn't navigate
          let frame = document.getElementById("hiddenDownloader");
          if (!frame) {
            frame = document.createElement("iframe");
            frame.id = "hiddenDownloader";
            frame.style.width = "0";
            frame.style.height = "0";
            frame.style.border = "0";
            frame.style.position = "absolute";
            frame.style.left = "-9999px";
            // Hide referrer (optional)
            frame.referrerPolicy = "no-referrer";
            document.body.appendChild(frame);
          }
          frame.src = driveURL;

          // Optional: user feedback if needed
          // setTimeout(() => alert("If your download didn't start, please try again."), 4000);
        });
      })
      .catch(err => {
        console.error("Error loading filelink.json:", err);
        const btn = document.getElementById("downloadBtn");
        btn.textContent = "Error loading download link.";
        btn.disabled = true;
      });
  </script>

  <!-- 1-hour redirect security -->
  <script>
    (function () {
      const startKey = "pageStartTime";
      const guardPage = "index.html";
      const ONE_HOUR = 60 * 60 * 1000;
      const CHECK_EVERY = 5 * 60 * 1000;

      let startTime = parseInt(localStorage.getItem(startKey), 10);
      if (Number.isNaN(startTime)) {
        startTime = Date.now();
        localStorage.setItem(startKey, String(startTime));
      }

      function msRemaining() {
        const elapsed = Date.now() - startTime;
        return Math.max(0, ONE_HOUR - elapsed);
      }

      function redirectToGuard() {
        try { localStorage.removeItem(startKey); } catch (e) {}
        window.location.replace(guardPage);
      }

      function checkAndRedirect() {
        if (msRemaining() <= 0) redirectToGuard();
      }

      const exactTimeout = setTimeout(checkAndRedirect, msRemaining());
      const interval = setInterval(checkAndRedirect, CHECK_EVERY);
      ["visibilitychange", "focus"].forEach(evt =>
        window.addEventListener(evt, checkAndRedirect)
      );
      window.addEventListener("beforeunload", () => {
        clearTimeout(exactTimeout);
        clearInterval(interval);
      });
    })();
  </script>

  <!-- Deterrents: block right-click and common inspect shortcuts -->
  <script>
    // Disable right-click context menu
    document.addEventListener("contextmenu", e => e.preventDefault());

    // Disable common view-source / devtools shortcuts (not bulletproof)
    document.addEventListener("keydown", e => {
      // F12
      if (e.key === "F12") e.preventDefault();

      // Ctrl/Cmd + (U,S,I,J,C) and Ctrl/Cmd+Shift+(I/J/C)
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && (k === "u" || k === "s" || k === "i" || k === "j" || k === "c")) {
        e.preventDefault();
      }
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && (k === "i" || k === "j" || k === "c")) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
